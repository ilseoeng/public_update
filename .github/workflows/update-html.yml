name: Update HTML Directly
on:
  release:
    types: [published]

permissions:
  contents: write

jobs:
  update-html:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Get Release Info
        id: release_info
        run: |
          # 1. MSI ë‹¤ìš´ë¡œë“œ ì£¼ì†Œ ì¶”ì¶œ (jq ì‚¬ìš©)
          # .msië¡œ ëë‚˜ëŠ” íŒŒì¼ì˜ ë‹¤ìš´ë¡œë“œ ì£¼ì†Œë¥¼ ê°€ì ¸ì˜µë‹ˆë‹¤.
          DOWNLOAD_URL=$(jq -r '.release.assets[] | select(.name | endswith(".msi")) | .browser_download_url' "$GITHUB_EVENT_PATH" | head -n 1)
          echo "DOWNLOAD_URL=$DOWNLOAD_URL" >> $GITHUB_ENV
          
          # 2. ë‚ ì§œ í¬ë§· ë³€ê²½ (YYYY-MM-DD)
          FORMATTED_DATE=$(date -d "${{ github.event.release.published_at }}" +'%Y-%m-%d')
          echo "FORMATTED_DATE=$FORMATTED_DATE" >> $GITHUB_ENV

      - name: Update index.html
        env:
          # Python ë‚´ë¶€ë¡œ ì•ˆì „í•˜ê²Œ ì „ë‹¬í•˜ê¸° ìœ„í•œ í™˜ê²½ë³€ìˆ˜ ì„¤ì •
          NEW_URL: ${{ env.DOWNLOAD_URL }}
          NEW_VERSION: ${{ github.event.release.tag_name }}
          NEW_DATE: ${{ env.FORMATTED_DATE }}
        run: |
          python3 -c "
          import os

          # í™˜ê²½ë³€ìˆ˜ ê°’ ê°€ì ¸ì˜¤ê¸°
          url = os.environ.get('NEW_URL')
          ver = os.environ.get('NEW_VERSION')
          date = os.environ.get('NEW_DATE')

          file_path = 'index.html'

          # íŒŒì¼ì´ ì—†ê±°ë‚˜ URLì„ ëª» ì°¾ì•˜ì„ ê²½ìš° ëŒ€ë¹„
          if not url:
              print('Error: .msi download URL not found.')
              exit(1)

          # HTML ì½ê¸°
          with open(file_path, 'r', encoding='utf-8') as f:
              lines = f.readlines()

          new_lines = []
          for line in lines:
              # [ì¤‘ìš”] 'if - elif - else' êµ¬ì¡°ë¥¼ ì‚¬ìš©í•˜ì—¬ ì¤‘ë³µ ë°©ì§€
              
              # 1. ë‹¤ìš´ë¡œë“œ ë²„íŠ¼ ì¤„ì„ ì°¾ìœ¼ë©´ -> ìƒˆ ë‚´ìš©ìœ¼ë¡œ êµì²´ (ê¸°ì¡´ ì¤„ ë²„ë¦¼)
              if 'id=\"download-btn\"' in line:
                  new_lines.append(f'        <a href=\"{url}\" id=\"download-btn\" class=\"btn\">ğŸ’¾ ìµœì‹  ë²„ì „ ë‹¤ìš´ë¡œë“œ</a>\n')
              
              # 2. ë²„ì „ í…ìŠ¤íŠ¸ ì¤„ì„ ì°¾ìœ¼ë©´ -> ìƒˆ ë‚´ìš©ìœ¼ë¡œ êµì²´ (ê¸°ì¡´ ì¤„ ë²„ë¦¼)
              elif 'id=\"version-text\"' in line:
                  new_lines.append(f'        <div id=\"version-text\" class=\"mt-2 text-xs text-gray-400\">Ver: <strong>{ver}</strong> ({date})</div>\n')
              
              # 3. í•´ë‹¹í•˜ì§€ ì•ŠëŠ” ì¤„ì€ -> ê·¸ëŒ€ë¡œ ìœ ì§€
              else:
                  new_lines.append(line)

          # ë³€ê²½ëœ ë‚´ìš© ì €ì¥
          with open(file_path, 'w', encoding='utf-8') as f:
              f.writelines(new_lines)
          
          print(f'Successfully updated {file_path}')
          "

      - name: Commit and Push
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
          
          git add index.html
          
          # ë³€ê²½ì‚¬í•­ í™•ì¸
          if git diff --staged --quiet; then
            echo "ë³€ê²½ì‚¬í•­ì´ ì—†ìŠµë‹ˆë‹¤. (ì´ë¯¸ ìµœì‹  ìƒíƒœì´ê±°ë‚˜ íŒŒì¼ì´ ë³€ê²½ë˜ì§€ ì•ŠìŒ)"
          else
            git commit -m "Auto-update index.html to ${{ github.event.release.tag_name }}"
            
            # [ì¤‘ìš”] ì›ê²© ë¸Œëœì¹˜(main)ì˜ ìµœì‹  ë‚´ìš©ì„ ê°€ì ¸ì™€ì„œ ì¶©ëŒ ë°©ì§€
            git pull origin main --rebase
            
            # ë³€ê²½ ë‚´ìš©ì„ main ë¸Œëœì¹˜ë¡œ ê°•ì œ í‘¸ì‹œ
            git push origin HEAD:main
          fi
