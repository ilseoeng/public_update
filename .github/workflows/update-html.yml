name: Update HTML Directly
on:
  release:
    types: [published]

permissions:
  contents: write

jobs:
  update-html:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Update index.html
        env:
          # ë¦´ë¦¬ìŠ¤ ì •ë³´ í™˜ê²½ë³€ìˆ˜ë¡œ ì €ì¥
          VERSION: ${{ github.event.release.tag_name }}
          DATE: ${{ github.event.release.published_at }}
        run: |
          # 1. MSI ë‹¤ìš´ë¡œë“œ ì£¼ì†Œ ì¶”ì¶œ (jq ì‚¬ìš©)
          DOWNLOAD_URL=$(jq -r '.release.assets[] | select(.name | endswith(".msi")) | .browser_download_url' "$GITHUB_EVENT_PATH" | head -n 1)
          
          # ë‚ ì§œ í¬ë§· ë³€ê²½ (YYYY-MM-DD)
          FORMATTED_DATE=$(date -d "$DATE" +'%Y-%m-%d')
          
          echo "ì—…ë°ì´íŠ¸ ì •ë³´: $VERSION / $FORMATTED_DATE"
          
          # 2. íŒŒì´ì¬ ìŠ¤í¬ë¦½íŠ¸ë¡œ HTML íŒŒì¼ ì§ì ‘ ìˆ˜ì • (ë” ì•ˆì „í•¨)
          python3 -c "
          import os

          # í™˜ê²½ë³€ìˆ˜ ê°€ì ¸ì˜¤ê¸°
          url = '$DOWNLOAD_URL'
          ver = '$VERSION'
          date = '$FORMATTED_DATE'
          
          # HTML íŒŒì¼ ì½ê¸°
          with open('index.html', 'r', encoding='utf-8') as f:
              lines = f.readlines()

          new_lines = []
          for line in lines:
              # ë‹¤ìš´ë¡œë“œ ë²„íŠ¼ ì¤„ ì°¾ì•„ì„œ êµì²´
              if 'id=\"download-btn\"' in line:
                  new_line = f'        <a href=\"{url}\" id=\"download-btn\" class=\"btn\">ğŸ’¾ ìµœì‹  ë²„ì „ ë‹¤ìš´ë¡œë“œ</a>\n'
                  new_lines.append(new_line)
              
              # ë²„ì „ í…ìŠ¤íŠ¸ ì¤„ ì°¾ì•„ì„œ êµì²´
              elif 'id=\"version-text\"' in line:
                  new_line = f'        <div id=\"version-text\" class=\"version-info\">Ver: <strong>{ver}</strong> ({date})</div>\n'
                  new_lines.append(new_line)
              
              else:
                  new_lines.append(line)

          # ë³€ê²½ëœ ë‚´ìš© ì €ì¥
          with open('index.html', 'w', encoding='utf-8') as f:
              f.writelines(new_lines)
          "

      - name: Commit and Push
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
          
          git add index.html
          if git diff --staged --quiet; then
            echo "ë³€ê²½ì‚¬í•­ì´ ì—†ìŠµë‹ˆë‹¤."
          else
            git commit -m "Auto-update index.html"
            # â–¼â–¼â–¼ ì—¬ê¸°ê°€ ìˆ˜ì •ëœ ë¶€ë¶„ì…ë‹ˆë‹¤ (HEAD:main ì¶”ê°€) â–¼â–¼â–¼
            git push origin HEAD:main
          fi
